{% extends "index.html" %}
{% block title %}Sign Up{% endblock %}
{%block content%}

<div class="d-flex justify-content-center" style="margin-top: 5%!important; min-width: 100%!important;">
    <div class="content-section pt-5" style="width: 50%!important;">
        <div id="form-response mb-3"></div>
<form action="/register" id="register-form" method="POST">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <fieldset class="form-group">
    <div class="form-group">
    <i class="fa fa-user fa-lg text-primary"></i>
      <label class="form-control-label" for="UsernameLabel">Username</label>
      <input type="text" class="form-control form-control-lg" id="username" placeholder="Enter username">
      <div class="invalid-feedback" id="username-invalid">
            <span></span>
    </div>
    </div>
    <div class="form-group">
        <i class="fa fa-lock fa-lg text-primary"></i>
        <label for="eMailLabel">E-Mail</label>
        <input type="email" class="form-control form-control-lg" id="eMail" placeholder="Enter E-Mail">
        <div class="invalid-feedback" id="eMail-invalid">
            <span></span>
    </div>
      </div>
    <div class="form-group">
        <i class="fa fa-lock fa-lg text-primary"></i>
      <label for="PasswordLabel">Password</label>
      <input type="password" class="form-control form-control-lg" id="password" placeholder="Enter password">
      <div class="invalid-feedback" id="password-invalid">
        <span></span>
    </div>
    </div>
      <div class="form-group">
        <i class="fa fa-check fa-lg text-primary"></i>
        <label for="ConfirmPassword">Confirm</label>
        <input type="password" class="form-control form-control-lg" id="confirmPassword" placeholder="Confirm password">
        <div class="invalid-feedback" id="confirmPassword-invalid">
            <span></span>
    </div>
      </div>
    </fieldset>
    <div class="form-group">
        <button type="submit" class="btn btn-outline-primary" id="register-form-button">Sign up</button>
    </div>
  </form>
  <div class="border-top pt-3">
    <small class="text-muted">
        Already have an account? <a class="ml-2" href="">Sign In</a>
    </small>
</div>
</div>
</div>

{%endblock%}

{% block scripts%}

<script type="text/javascript">
$('#register-form-button').click(function(event){
    event.preventDefault()
    var form = $('#register-form');
    var url = form.prop('action');
    var type = form.prop('method');
    var form_data = {
        username: document.getElementById("username").value,
        eMail: document.getElementById("eMail").value,
        password: document.getElementById("password").value,
        confirmPassword: document.getElementById("confirmPassword").value
    }

    if((checkFormIsFilled(form_data) && formIsValid(form_data)) == true)
    {
        //console.log("form is valid")
        document.getElementById("username").value = ""
        document.getElementById("eMail").value = ""
        document.getElementById("password").value = ""
        document.getElementById("confirmPassword").value = ""

        modular_ajax(url, type, form_data)
    }


});

function checkFormIsFilled(form_data)
{
    var valid = true
   for(const [key, value] of Object.entries(form_data))
   {
       if(value == "")
       {
            var item = document.getElementById(key)
            item.className += (" is-invalid")
            var error_item = document.getElementById(key + "-invalid")
            error_item.innerText = "Input required! Please enter a proper value."
            valid = false
       }
   }
   return valid
}

function formIsValid(form_data)
{
    var form_error = false
    if(!form_data.hasOwnProperty("username") && !form_data.hasOwnProperty("eMail") && !form_data.hasOwnProperty("password") && !form_data.hasOwnProperty("confirmPassword"))
    {
        return false
    }


    var emailError = validateEmail(form_data.eMail, "eMail")
    var passwdError = validatePassword(form_data.password, "password")
    var confirmPasswdError = validateConfirm(form_data.password, form_data.confirmPassword, "confirmPassword")
    //console.log(emailError && passwdError && confirmPasswdError)
    return emailError && passwdError && confirmPasswdError
}

function validateEmail(email, id_key) {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    if(re.test(String(email).toLowerCase()) == false)
    {
        var item = document.getElementById(id_key)
        item.className += " is-invalid"
        var error_item = document.getElementById(id_key+"-invalid")
        error_item.innerText = "Invalid e-mail address. Please try again."
        return false
    }
    return true
}

function validatePassword(passwd, id_key)
{
    if(passwd.length < 8)
    {
        var item = document.getElementById(id_key)
        item.className += " is-invalid"
        var error_item = document.getElementById(id_key+"-invalid")
        error_item.innerText = "Password length has to be at least 8. Please try again."
        return false
    }
    return true
}

function validateConfirm(password, confirmPassword, id_key)
{
    if(password != confirmPassword)
    {
        var item = document.getElementById(id_key)
        item.className += " is-invalid"
        var error_item = document.getElementById(id_key+"-invalid")
        error_item.innerText = "Passwords has to be the same. Please try again."
        return false
    }
    return true
}


function modular_ajax(url, type, formData) {
    // Most simple modular AJAX building block
    var csrftoken = $('meta[name=csrf-token]').attr('content')
    $.ajax({
        url: url,
        type: type,
        data: JSON.stringify(formData),
        processData: false,
        headers: { "X-CSRFToken": csrftoken },
        dataType: "json",
        contentType: "application/json",
        beforeSend: function() {
            // show the preloader (progress bar)
            $('#form-response').html("<div class='progress'><div class='indeterminate'></div></div>");
        },
        complete: function () {
            // hide the preloader (progress bar)
            $('#form-response').html("");
        },
        success: function ( data ){
            if ( !$.trim( data.feedback )) { // response from Flask is empty
                printMessageWithCategory("Error appeared!", "Empty response of server.", "danger");
            }
        },
        error: function(xhr) {console.log("error. see details below.");
            //console.log(xhr.status + ": " + xhr.responseText);
            printMessageWithCategory("Upps!", data.feedback, data.category);
        },
    }).done(function() {
        $(".content-section").html('<div class="modal" tabindex="-1" role="dialog" style="margin-top: 10%"> \
    <div class="modal-dialog" role="document"> \
      <div class="modal-content"> \
        <div class="modal-header"> \
          <h5 class="modal-title">Registration Success</h5> \
        </div> \
        <div class="modal-body"> \
        <i class="fa fa-check fa-2x" style="float: right; color: green; display: inline-block; border-radius: 50%; border: 5px solid green; padding: 20px;"></i> \
          <p style="margin-top: 30px">Thank you for creating an account!</p> \
        </div> \
        <div class="modal-footer"> \
          <button id="goToSignInButton" type="button" class="btn btn-primary">Sign In</button> \
        </div> \
      </div> \
    </div> \
  </div>')
  $(".modal").show()
    });
};


//var csrf_token = "{{ csrf_token() }}";

/*
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        console.log("iam inside this function")
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            //xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
    }
});
*/

function printMessageWithCategory(msg_title, msg_body, category)
{
    if (category != "success" || category != "warning" || category != "danger")
    {
        throw "Invalid argument exception: expected category like [success, warning, danger]."
    }
    $('#form-response').html('<div class="alert alert-${category}" role="alert">\
    <h4 class="alert-heading">${msg_title}</h4>\
    <p>${msg_body}</p><hr>')
}
</script>
{% endblock %}